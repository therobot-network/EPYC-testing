# EC2-specific configuration for EPYC-testing

# EC2 Instance Details
ec2:
  instance_id: "i-00268dae9fd36421f"
  public_ip: "54.151.76.197"
  private_ip: "172.31.11.209"
  instance_type: "c6a.24xlarge"
  region: "us-west-1"
  availability_zone: "us-west-1c"
  
# Connection Settings
connection:
  user: "ubuntu"  # Ubuntu instances use ubuntu user
  pem_key: "griffin-connect.pem"
  ssh_timeout: 10
  remote_directory: "/home/ubuntu/EPYC-testing"

# Application Settings for EC2
application:
  host: "0.0.0.0"  # Bind to all interfaces on EC2
  port: 8000
  workers: 24  # Reduced from 96 to prevent threading issues
  log_level: "INFO"
  
# Performance Optimizations for c6a.24xlarge
performance:
  max_memory_gb: 192  # c6a.24xlarge has 192GB RAM
  cpu_cores: 96       # c6a.24xlarge has 96 vCPUs
  torch_threads: 24   # Reduced to prevent contention (was 96)
  batch_size: 16      # Reduced for memory efficiency
  
  # CPU Optimization Settings with Quantization
  cpu_inference: true
  load_in_8bit: true   # ENABLED to reduce memory usage from ~140GB to ~70GB
  load_in_4bit: false  # Keep disabled for stability
  torch_dtype: "float16"  # Half precision for optimal performance on AMD EPYC
  low_cpu_mem_usage: true
  use_half_precision: false  # Disabled when using quantization
  
  # AMD EPYC specific optimizations
  use_mkl: true  # Enable Intel MKL for optimized BLAS operations
  mkl_threads: 24  # Reduced to match torch_threads
  omp_num_threads: 24  # Reduced OpenMP threading
  
  # Memory management for quantized model
  gradient_checkpointing: true  # Save memory during inference
  max_memory_per_gpu: null  # CPU-only inference
  device_map: "cpu"  # Force CPU device mapping
  
  # Generation Settings optimized for CPU quantized inference
  max_new_tokens: 512   # Reasonable default
  temperature: 0.7
  top_p: 0.9
  do_sample: true
  
  # AMD EPYC specific SIMD optimizations (reduced for stability)
  use_avx2: true  # Enable AVX2 SIMD instructions
  use_avx512: false  # Disabled to prevent thermal issues
  vectorization: true  # Enable vectorization optimizations
  
# Storage Paths on EC2
storage:
  model_cache: "/home/ubuntu/EPYC-testing/models"
  logs: "/home/ubuntu/EPYC-testing/logs"
  temp: "/tmp/epyc-testing"
  
# Security Settings
security:
  allowed_hosts:
    - "54.151.76.197"
    - "172.31.11.209"
    - "localhost"
    - "127.0.0.1"
  cors_origins:
    - "http://54.151.76.197:8000"
    - "http://localhost:8000"
    
# Monitoring
monitoring:
  health_check_interval: 30
  log_rotation_size: "100MB"
  log_retention_days: 7 